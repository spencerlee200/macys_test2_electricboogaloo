wwplayer.define(["jquery","underscore","AnimationController","pubsub","globals"],function(e,t,n,a,i){var r;return n.extend({init:function(n,l,o,s){r=this,this._super(n,l,o,s),r.comeInTimers=[],r.leaveTimers=[],r.frameRepresentedTagData={},r.tagsIn={},r.animatingTags=[],r.animatingStaticTags=[],r.staticPositions={},r.frameSubscriptionUnsubCallbacks=[],r.startedAnimFn=!1,r.last360Position={pitch:null,yaw:null},r.currentClipIndex=null,a.subscribe(i.HAS_SEEKED,function(){t.each(r.animatingStaticTags,function(e){e.hasBrungInStatic=!1}),r.startAnimFn()}),a.subscribe(i.HAS_PLAYED,function(){r.startAnimFn()}),a.subscribe(i.NEW_CLIP,function(e,t){r.currentClipIndex=t}),a.subscribe(i.WIDGET_SHOWN,function(){e("#tag-overlay").fadeOut()}),a.subscribe(i.WIDGET_CLOSED,function(){e("#tag-overlay").fadeIn()}),i.HIDE_STATICS=!1},startAnimFn:function(){r.startedAnimFn||(r.startedAnimFn=!0,window.requestAnimationFrame(r.animFn))},_refactorTagData:function(t,n,a,i){if(a.fixedElement){for(var r=null,l={},o={},s=t.x.length,m=0;m<s;m++){var c=n+t.in+m-1;l[c]={left:Math.round(1e4*(t.x[m]-t.w[m]/2))/1e4,top:Math.round(1e4*(t.y[m]-t.h[m]/2))/1e4,height:parseFloat(t.h[m]),width:parseFloat(t.w[m]),centerTop:parseFloat(t.y[m]),centerLeft:parseFloat(t.x[m])};var p=a.getKeyFrameCSS({top:l[c].top,left:l[c].left,width:l[c].width,height:l[c].height});for(var d in p)l[c][d]="auto"===p[d]?"auto":parseFloat(p[d])/100;r||(r=l[c].top)}e.when(a.getFixedElementData()).then(function(m){for(var c=0;c<s;c++){var p=n+t.in+c-1;if(m.radius){var d=m.frequency,h=m.radius,f=m.direction;o[p]={left:parseFloat(m.left)+Math.cos(Math.PI*(f*c*d))*h,top:parseFloat(m.top)+Math.sin(Math.PI*(f*c*d))*h*(16/9)}}else o[p]=m}a.boundryMarkerElement=e('<div id="tag-marker-'+a.spriteId+'" style="display: none; top: '+100*r+'%" class="tag-marker to-left" data-marker-sprite-id="'+a.spriteId+'"</div>'),a.enable360TagMarkers&&e("#control-overlay").append(a.boundryMarkerElement),a.newTagData={movingElement:l,fixedElement:o},a.movingElement.style.display="none",a.fixedElement.style.display="none",a.lineElement.style.display="none",i()})}else{for(var h={},r=null,s=t.x.length,m=0;m<s;m++){var c=n+t.in+m-1;h[c]={left:Math.round(1e4*(t.x[m]-t.w[m]/2))/1e4,top:Math.round(1e4*(t.y[m]-t.h[m]/2))/1e4,height:parseFloat(t.h[m]),width:parseFloat(t.w[m]),centerTop:parseFloat(t.y[m]),centerLeft:parseFloat(t.x[m])};var p=a.getKeyFrameCSS({top:h[c].top,left:h[c].left,width:h[c].width,height:h[c].height});for(var d in p)h[c][d]="auto"===p[d]?"auto":parseFloat(p[d])/100;r||(r=h[c].top)}a.boundryMarkerElement=e('<div id="tag-marker-'+a.spriteId+'" style="display: none; top: '+100*r+'%" class="tag-marker to-left" data-marker-sprite-id="'+a.spriteId+'"</div>'),a.enable360TagMarkers&&e("#control-overlay").append(a.boundryMarkerElement),a.newTagData=h,i()}},createAnimations:function(e,n,l,o){t.each(r.frameSubscriptionUnsubCallbacks,function(e){"function"==typeof e&&e()}),r.comeInTimers=[],r.leaveTimers=[],r.frameRepresentedTagData={},r.tagsIn={},r.animatingTags=[],r.staticPositions={},r.frameSubscriptionUnsubCallbacks=[];var s=0,m=0,c=function(){++m>=s&&(o?a.publish(i.HIDE_LOADER):r.animationsCreated())};t.each(e,function(e,a){t.each(e.tags,function(e,a){t.find(n,function(t){return t.spriteId===e.spriteId})&&s++})}),s>0?t.each(e,function(e,a){t.each(e.tags,function(a,i){var l=t.find(n,function(e){return e.spriteId===a.spriteId});l&&r._refactorTagData(a,e.in,l,c)})}):c();for(var p in l)if(n["-1-"+p]){var d=l[p],h="",f=0,y=parseFloat(d.w[0]),g=parseFloat(d.h[0]),u=parseFloat(d.y[0])-.5*g,b=parseFloat(d.x[0])-.5*y;if(n["-1-"+p].overridePosition())h+=f+"% {visibility: visible;}\r\n",f=100,h+=f+"% {visibility: visible;}\r\n",r.staticPositions["s"+p]={visibility:"visible"};else{var E={top:100*u+"%;",left:100*b+"%;",width:100*y+"%;",height:100*g+"%;",visibility:"visible"},v=n["-1-"+p].getKeyFrameCSS({top:u,left:b,width:y,height:g});for(var w in v)E[w]=v[w];r.staticPositions["s"+p]=E}r.animateStaticTag(n["-1-"+p])}},animateStaticTag:function(n){var a=this;n.element.style.display="none",e(n.element).css(a.staticPositions[n.tagIndex]),n.hasBrungInStatic=!1,t.contains(a.animatingStaticTags,n)||a.animatingStaticTags.push(n)},animFn:function(){if(r.player.playing()||r.last360Position.yaw!==r.player.config.yaw||r.last360Position.pitch!==r.player.config.pitch){r.last360Position={pitch:r.player.config.pitch,yaw:r.player.config.yaw};var n=i.GET_CURRENT_PLAYING_TIME(),a=parseFloat(n*r.fps)+1,l=Math.floor(a),o=Math.ceil(a),s=a-l,m=r.player.config.pitch,c=r.player.config.yaw,p=r.player.config.hfov,d=r.player.renderer.getCanvas(),h=d.width/(window.devicePixelRatio||1),f=d.height/(window.devicePixelRatio||1),y=[],g=r.animatingTags;r.currentClipIndex&&(g=t.where(r.animatingTags,{clipIndex:r.currentClipIndex.toString()})),g.forEach(function(t){if(!t.newTagData)return t.element.style.display="none",void(t.boundryMarkerElement[0].style.display="none");if(t.fixedElement){var n=t.newTagData.movingElement[l],a=t.newTagData.movingElement[o],r=t.newTagData.fixedElement[l],d=t.newTagData.fixedElement[o];if(n&&a&&r&&d){var g=170*(1-n.top)-85-5,u=360*n.centerLeft-180,b=Math.sin(g*Math.PI/180),E=Math.cos(g*Math.PI/180),v=Math.sin(m*Math.PI/180),w=Math.cos(m*Math.PI/180),T=Math.cos((-u+c)*Math.PI/180),M=Math.tan(p*Math.PI/360),I=b*v+E*T*w;if(t.currentYaw=u,y.push(t),u>=c-.5*p&&u<=c+.5*p?t.boundryMarkerElement[0].style.display="none":u<=c-.5*p?(t.boundryMarkerElement[0].style.display="block",t.boundryMarkerElement[0].className="tag-marker to-left"):(t.boundryMarkerElement[0].style.display="block",t.boundryMarkerElement[0].className="tag-marker to-right"),u<=45&&u>-45&&I<=0||(u>45||u<=-45)&&I<=0)t.element.style.display="none";else{t.element.style.display="block";var k=-h/M*Math.sin((-u+c)*Math.PI/180)*E/I/2+h/2-1*n.width*i.OVERLAY_WIDTH,F=-h/M*(b*w-E*T*v)/I/2+f/2-.5*n.height*i.OVERLAY_HEIGHT,x="translate("+k+"px, "+F+"px) translateZ(0)";t.movingElement.style.webkitTransform=x,t.movingElement.style.MozTransform=x,t.movingElement.style.transform=x,t.movingElement.style.display="block";var P=n.width,S=n.height;t.movingElement.style.width=250*P+"%",t.movingElement.style.height=250*S+"%",t.fixedElement.style.display="block";var A=r.left+(d.left-r.left)*s,_=r.top+(d.top-r.top)*s;t.fixedElement.style.left=100*A+"%",t.fixedElement.style.top=100*_+"%";var D={top:e(t.movingElement).position().top+e(t.movingElement).height()/2,left:e(t.movingElement).position().left+e(t.movingElement).width()/2},C=e(t.fixedElement).position(),L={left:A,top:_,width:function(e,t){return Math.sqrt(Math.pow(e.left-t.left,2)+Math.pow(e.top-t.top,2))}(D,C),rotate:function(e,t){return 180*Math.atan2(e.top-t.top,e.left-t.left)/Math.PI}(D,C)};t.lineElement.style.display="block",t.lineElement.style.width=L.width+"px",t.lineElement.style.left=100*L.left+"%",t.lineElement.style.top=100*L.top+"%",t.lineElement.style["transform-origin"]="0% 50%",t.lineElement.style.transform="rotate("+L.rotate+"deg)",t.lineElement.style["-webkit-transform-origin"]="0% 50%",t.lineElement.style["-webkit-transform"]="rotate("+L.rotate+"deg)",t.lineElement.style["-ms-transform-origin"]="0% 50%",t.lineElement.style["-ms-transform"]="rotate("+L.rotate+"deg)";100*L.width/e("#tag-overlay").width()>45&&(t.element.style.display="none")}}else t.boundryMarkerElement[0].style.display="none",t.element.style.display="none"}else{var n=t.newTagData[l];if(n){var g=170*(1-n.top)-85-5,u=360*n.centerLeft-180,b=Math.sin(g*Math.PI/180),E=Math.cos(g*Math.PI/180),v=Math.sin(m*Math.PI/180),w=Math.cos(m*Math.PI/180),T=Math.cos((-u+c)*Math.PI/180),M=Math.tan(p*Math.PI/360),I=b*v+E*T*w;if(t.currentYaw=u,y.push(t),u>=c-.5*p&&u<=c+.5*p?t.boundryMarkerElement[0].style.display="none":u<=c-.5*p?(t.boundryMarkerElement[0].style.display="block",t.boundryMarkerElement[0].className="tag-marker to-left"):(t.boundryMarkerElement[0].style.display="block",t.boundryMarkerElement[0].className="tag-marker to-right"),u<=90&&u>-90&&I<=0||(u>90||u<=-90)&&I<=0)t.element.style.display="none";else{t.element.style.display="block";var x="translate("+(-h/M*Math.sin((-u+c)*Math.PI/180)*E/I/2+h/2-.5*n.width*i.OVERLAY_WIDTH)+"px, "+(-h/M*(b*w-E*T*v)/I/2+f/2-.5*n.height*i.OVERLAY_HEIGHT)+"px) translateZ(9999px)";t.element.style.webkitTransform=x,t.element.style.MozTransform=x,t.element.style.transform=x;var H=100*n.width+"%",R=100*n.height+"%";t.element.style.width=H,t.element.style.height=R}}else t.boundryMarkerElement[0].style.display="none",t.element.style.display="none"}}),r.animatingStaticTags.forEach(function(e){e.tagStartTime<=n&&e.tagAnimationTime+e.tagStartTime>=n?(e.element.style.display="block",e.element.style.visibility="visible",e.hasBrungInStatic||(e.hasBrungInStatic=!0,e.bringIn())):e.element.style.display="none"})}t.each(r.tagAnimationCallbacks,function(e){e(y)}),window.requestAnimationFrame(r.animFn)},animateTag:function(e,n,a,i){var r=this;if(0!==this.tagDisplayMode)if(i)a>0?(e._bringInTimeout&&window.clearTimeout(e._bringInTimeout),e._bringInTimeout=window.setTimeout(function(){e.bringIn(e),e._bringInTimeout=null},1e3*a)):e.bringIn(e),r.startAnimFn(),e.isStatic||t.contains(r.animatingTags,e)||r.animatingTags.push(e);else{var l=1/r.fps;r.comeInTimers.push(window.setTimeout(function(){r.leaveTimers.push(window.setTimeout(function(){},n*l*1e3))},1e3*a))}e.isStatic&&r.startAnimFn(),this._super(e,n,a)},pauseAnimation:function(e){e._bringInTimeout&&window.clearTimeout(e._bringInTimeout)},animateTo:function(t,n,a,i,r,l){window.setTimeout(function(){e(t).animate(a,1e3*n,"linear",l)},1e3*i)},pauseTagAtPosition:function(e,t){e._bringInTimeout&&window.clearTimeout(e._bringInTimeout)}})});