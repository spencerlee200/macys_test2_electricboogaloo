wwplayer.define(["jquery","underscore","AbstractPlayer","DeviceOrientationModule","pubsub","globals","modernizr","LogEvent","apiService","require-shim","libpannellum2","pannellum2","iphone-inline-video"],function(e,n,t,i,o,a,r,c,d,l,s,u,h){"use strict";var f;return t.extend({init:function(n,t,r,c,d,l){this._super(n,t,r,c,d,l),f=this,f.refreshRate=a.IS_IPHONE?5:0,f.vidId=e(n).attr("data-vidid"),f.stallLoopCount=0,f.lastCheckedStallTime=0,f.has360Controls=!("touchend"===a.CLICK_EVENT),f.has360Radar=!0,f.canUpdate360View=!0,f.renditionCodes=l.renditionCodes,f.touchesInAction={},f.dragDisabled=!1,window.wirewax.vidOverride&&(f.vidId=window.wirewax.vidOverride),f.posterUrl=window.wirewax.cdnUrl+"vidData/"+f.vidId+"/poster/poster.jpg",window.wirewax.blackPoster?f.posterUrl="//edge-assets.wirewax.com/creativeData/pureblack.jpg":window.wirewax.posterUrl&&(f.posterUrl=window.wirewax.posterUrl),a.PREVENT_VIDEO_CLICK=!0,a.ENABLE_360_METRICS=!0,f.forceVideoElementContainerAsResizeReference=!0,f._time=0,f.config={hfov:a.HFOV,minHfov:50,maxHfov:120,pitch:0,minPitch:-85,maxPitch:85,yaw:l.startingYaw360||a.STARTING_YAW,minYaw:-180,maxYaw:180,haov:360,vaov:180,vOffset:0,autoRotate:!1,autoRotateInactivityDelay:-1,type:"equirectangular",northOffset:0,dynamic:!0,debug:window.wirewax.debug},f.deviceConfig={deviceYaw:0,devicePitch:0,deviceYawDefice:0,devicePitchDefice:0},f.videoElement=e('<div id="wireWaxVideo"></div>'),l.fixedImage360 = "/public/offline/creativeData/BBDO/Macys/Assets/Macys_360_PNG.png",l.fixedImage360&&(f.fixedImage360=l.fixedImage360,a.ENABLE_IMAGE_SOURCE=!0),(a.IS_IE_11||a.IS_EDGE)&&(a.ENABLE_VIDEO_CANVAS_SOURCE=!0),f.overrideGlobalRendition(),f.create360Video(n,c),f.buildTurnPhonePanel(),f.setOrientationChangeListenner(),a.IS_DESKTOP||(f.deviceOrientationModule=new i(function(e){f.update360ViewByDeviceOrientation(e.alpha,e.gamma,null)})),o.subscribe(a.WIDGET_SHOWN,function(e){f.canUpdate360View=!1}),o.subscribe(a.WIDGET_CLOSED,function(e){f.canUpdate360View=!0}),o.subscribe(a.ENABLE_AUDIO,f.enableAudio)},create360Video:function(t,i){var r="",d="";a.IS_DESKTOP&&"4k"===a.BANDWIDTH_PREFERRED_RENDITION&&(r=f.cdnURL+"vidData/"+f.vidId+"/"+f.vidId+"_4k.mp4",f.renditionCodes&&(n.contains(f.renditionCodes.split(","),"31")||n.contains(f.renditionCodes.split(","),"30"))&&(d=f.cdnURL+"vidData/"+f.vidId+"/"+f.vidId+"_4k.webm"));var l=f.cdnURL+"vidData/"+f.vidId+"/"+f.vidId+"_"+a.RENDITION+".mp4",u=f.cdnURL+"vidData/"+f.vidId+"/"+f.vidId+"_"+a.RENDITION+".webm";f.internalVideoElement=f.createVideoElement(f.posterUrl,l,u,r,d),f.setupLoadTimeEvent(),a.ENABLE_IMAGE_SOURCE&&(f.createImageSource(),f.config.dynamic=!1),a.ENABLE_VIDEO_CANVAS_SOURCE?f.createVideoInCanvasSource():f.source360=f.internalVideoElement;try{f.renderer=new s.renderer(f.videoElement[0],f.source360,f.config.type,f.config.dynamic),window.setTimeout(function(){i(f.videoElement)},50)}catch(e){"webgl error"==e.type||"no webgl"==e.type?o.publish(a.ERROR,new c(a.ERROR,a.ERRORS[5004])):"webgl size error"==e.type&&o.publish(a.ERROR,new c(a.ERROR,a.ERRORS[5003]))}e(t).append(f.videoElement)},setOrientationChangeListenner:function(){window!=window.top?o.subscribe(a.DEVICE_SCREEN_ORIENTATION,function(e,n){f.screenOrientation=n,f.handleScreenOrientation()}):(f.screenOrientation=window.orientation,window.addEventListener("orientationchange",function(){f.screenOrientation=window.orientation,f.handleScreenOrientation()},!1))},getYawAndPitch:function(){return{yaw:f.config.yaw,pitch:f.config.pitch}},handleScreenOrientation:function(){if(!a.IS_DESKTOP&&!window.wirewax.allow360Portrait&&f.controlEventsAttached)switch(f.screenOrientation){case 0:case 180:f.showTurnPhonePanel();break;case-90:case 90:f.config.forceUpdate=!0,f.hideTurnPhonePanel()}},buildTurnPhonePanel:function(){f.turnPhonePanel=e('<img class="turn-phone-message" src="https://edge-assets.wirewax.com/creativeData/360/360message-01.svg">'),e("#control-overlay").append(f.turnPhonePanel)},showTurnPhonePanel:function(){e(f.turnPhonePanel).show(),e("#tag-overlay").hide()},hideTurnPhonePanel:function(){e(f.turnPhonePanel).hide(),e("#tag-overlay").show()},attachControlEvents:function(t){f.controlEventsAttached||(t.addEventListener("mousemove",n.throttle(this.onMouseMove.bind(this),40),!1),t.addEventListener("mousedown",this.onMouseDown.bind(this),!1),t.addEventListener("mouseup",this.onMouseUp.bind(this),!1),e(document)[0].addEventListener("keydown",n.throttle(this.onKeyDown.bind(this),40),!1),t.addEventListener("touchstart",f.touchStartHandler,!1),t.addEventListener("touchmove",f.touchMoveHandler,!1),t.addEventListener("touchend",f.touchEndHandler,!1),f.controlEventsAttached=!0,f.handleScreenOrientation())},touchStartHandler:function(e){if(!1===f.dragDisabled&&"tag-overlay"===e.target.id){var n=e.changedTouches;f.touchesInAction["$"+n[0].identifier]={identifier:n[0].identifier,pageX:n[0].pageX,pageY:n[0].pageY,yaw:f.config.yaw,pitch:f.config.pitch},(a.IS_IPHONE||a.IS_IPAD)&&f.checkDoubletap(),e.stopPropagation()}},checkDoubletap:function(){var e=(new Date).getTime(),n=e-f.mylatesttap;n<400&&n>0&&(!a.DISABLE_MOBILE_DOUBLE_TAP||a.IS_DESKTOP)&&(a.PREVENT_VIDEO_DOUBLE_CLICK||f.playPause()),f.mylatesttap=(new Date).getTime()},touchMoveHandler:function(e){if("tag-overlay"===e.target.id){e.preventDefault();var n=e.changedTouches,t=f.touchesInAction["$"+n[0].identifier],i=f.renderer.getCanvas(),o=180*(Math.atan(t.pageX/i.width*2-1)-Math.atan(n[0].pageX/i.width*2-1))/Math.PI*f.config.hfov/30+t.yaw;f.config.yaw=o%360;var a=2*Math.atan(Math.tan(f.config.hfov/360*Math.PI)*i.height/i.width)*180/Math.PI,r=180*(Math.atan(n[0].pageY/i.height*2-1)-Math.atan(t.pageY/i.height*2-1))/Math.PI*a/45+t.pitch;f.config.pitch=r%360,f.setDeviceOrientationStartPosition(f.config.yaw,f.config.pitch),f.onLoopUpdate()}},touchEndHandler:function(){f.touchesInAction={}},valBetween:function(e,n,t){return Math.min(t,Math.max(n,e))},setDeviceOrientationStartPosition:function(e,n){f.deviceConfig.deviceYawDefice=f.deviceConfig.deviceYaw-e,f.deviceConfig.devicePitchDefice=f.deviceConfig.devicePitch-n},update360ViewByDeviceOrientation:function(n,t){if(!1===f.dragDisabled&&e.isEmptyObject(f.touchesInAction)){f.deviceConfig.deviceYaw=n%360,f.deviceConfig.devicePitch=t,n-=f.deviceConfig.deviceYawDefice%360,t-=f.deviceConfig.devicePitchDefice;var i=(f.config.yaw-n)%360,o=(f.config.pitch-t)%360;(f.checkYawThresholds(i)||f.config.forceUpdate)&&(f.config.yaw=n),(f.config.forceUpdate||f.checkPitchThresholds(o))&&t<=45&&t>=-45&&(f.config.pitch=t),f.config.forceUpdate=!1,f.onLoopUpdate()}},checkYawThresholds:function(e){return e<40&&e>-40||e<-320&&e>=-360||e>320&&e<=360},checkPitchThresholds:function(e){return e<40&&e>-40},onKeyDown:function(e){switch(e.keyCode){case 37:f.goLeft();break;case 38:f.goDown();break;case 39:f.goRight();break;case 40:f.goUp()}e.stopPropagation()},goLeft:function(e){e=e||1,f.config.yaw=(f.config.yaw-e)%360,f.playing()||f.onLoopUpdate()},goRight:function(e){e=e||1,f.config.yaw=(f.config.yaw+e)%360,f.playing()||f.onLoopUpdate()},goUp:function(e){e=e||1,f.config.pitch=Math.max(f.config.pitch-e,-85),f.playing()||f.onLoopUpdate()},goDown:function(e){e=e||1,f.config.pitch=Math.min(f.config.pitch+e,85),f.playing()||f.onLoopUpdate()},onMouseMove:function(e){if(!1===f.dragDisabled&&f.isUserInteracting){f.latestInteraction=Date.now();var n=f.renderer.getCanvas(),t=f.mousePosition(e),i=180*(Math.atan(f.onPointerDownPointerX/n.width*2-1)-Math.atan(t.x/n.width*2-1))/Math.PI*f.config.hfov/30+f.onPointerDownYaw;f.yawSpeed=(i-f.config.yaw)%360*.2,f.config.yaw=i;var o=2*Math.atan(Math.tan(f.config.hfov/360*Math.PI)*n.height/n.width)*180/Math.PI,a=180*(Math.atan(t.y/n.height*2-1)-Math.atan(f.onPointerDownPointerY/n.height*2-1))/Math.PI*o/45+f.onPointerDownPitch;f.pitchSpeed=.2*(a-f.config.pitch),f.config.pitch=a,f.playing()||f.onLoopUpdate()}},mousePosition:function(n){var t=e("#waxxer")[0].getBoundingClientRect(),i={};return i.x=n.clientX-t.left,i.y=n.clientY-t.top,i},mouseEventToCoords:function(e){var n=f.mousePosition(e),t=f.renderer.getCanvas(),i=n.x/t.width*2-1,o=(1-n.y/t.height*2)*t.height/t.width,a=1/Math.tan(f.config.hfov*Math.PI/360),r=Math.sin(f.config.pitch*Math.PI/180),c=Math.cos(f.config.pitch*Math.PI/180),d=a*c-o*r,l=Math.sqrt(i*i+d*d);return[180*Math.atan((o*c+a*r)/l)/Math.PI,180*Math.atan2(i/l,d/l)/Math.PI+f.config.yaw]},onMouseDown:function(e){if(e.preventDefault(),f.canUpdate360View){var n=f.mousePosition(e);f.isUserInteracting=!0,f.latestInteraction=Date.now(),f.onPointerDownPointerX=n.x,f.onPointerDownPointerY=n.y,f.onPointerDownYaw=f.config.yaw,f.onPointerDownPitch=f.config.pitch}},onMouseUp:function(e){f.isUserInteracting&&(f.isUserInteracting=!1,Date.now()-f.latestInteraction>15&&(f.pitchSpeed=f.yawSpeed=0))},overrideGlobalRendition:function(){a.FORCE_RENDITION?a.RENDITION=a.FORCE_RENDITION:a.IS_IPHONE&&(a.RENDITION="1080")},onResize:function(e,n){f.renderer.resize()},onLoopUpdate:function(){f.canUpdate360View&&this.render()},render:function(){f.rendererInit&&(f.config.yaw>180?f.config.yaw-=360:f.config.yaw<-180&&(f.config.yaw+=360),f.config.yaw=Math.max(f.config.minYaw,Math.min(f.config.maxYaw,f.config.yaw)),f.config.pitch=Math.max(f.config.minPitch,Math.min(f.config.maxPitch,f.config.pitch)),a.ENABLE_VIDEO_CANVAS_SOURCE&&(f.internalVideoElement.paused||f.internalVideoElement.ended||f.ie11canvas.context.drawImage(f.internalVideoElement,0,0,f.ie11canvas.width,f.ie11canvas.height)),f.renderer.render(f.config.pitch*Math.PI/180,f.config.yaw*Math.PI/180,f.config.hfov*Math.PI/180))},retryInit:function(e,n){try{f.rendererInit=!0;var t=f.config.haov*Math.PI/180,i=f.config.vaov*Math.PI/180,r=f.config.vOffset*Math.PI/180,d={},l=f.source360,s=f.config.type,u=f.config.dynamic;f.renderer.init(l,s,u,t,i,r,n,d),o.publish(a.HIDE_LOADER)}catch(t){e++<3?setTimeout(f.retryInit.bind(f,e,n),1e3):(o.publish(a.HIDE_LOADER),o.publish(a.WEBGLERROR,"webglerror"),o.publish(a.ERROR,new c(a.ERROR,a.ERRORS[5033])),n(a.WEBGLERROR))}finally{f.rendererInit&&n()}},initRenderer:function(e){f.rendererInit?e():(o.publish(a.SHOW_LOADER),f.retryInit(0,e))},checkForStall:function(){if(f.stallCheckTimeout)return void(f.stallLoopCount=0);if(!f.playing()&&f.stalled&&(f.stalled=!1,o.publish(a.HIDE_LOADER)),f.stallLoopCount>30){f.stallLoopCount=0;var e=f.getCurrentTime();f.stalled||e!==f.lastCheckedStallTime?f.stalled&&e!==f.lastCheckedStallTime&&(f.stalled=!1,o.publish(a.HIDE_LOADER)):(f.stalled=!0,o.publish(a.SHOW_LOADER)),f.lastCheckedStallTime=e}else f.stallLoopCount=f.stallLoopCount+1},enableAudio:function(e,n){(a.AUDIO_DISABLED||n)&&(f.internalVideoElement.muted=!1,a.AUDIO_DISABLED=!1,o.publish(a.VOLUME_CHANGE,a.VOLUME))},disableAudio:function(){f.internalVideoElement.muted=!0,o.publish(a.VOLUME_CHANGE,0)},createVideoElement:function(n,t,i,o,r){window.wirewax.onVideoError=function(){f.onError(arguments)};var c;if(a.REQUIRES_BAGEL?(c=e('<video preload="auto" src="'+t+'" crossorigin="anonymous" webkit-playsinline playsinline id="wireWaxVideo"></video>')[0],f.iphonePlayer=h(c,f.refreshRate)):c=a.IOS_VERSION>10||a.IS_DESKTOP&&a.IS_SAFARI?e('<video preload="auto" src="'+t+'" crossorigin="anonymous" webkit-playsinline playsinline id="wireWaxVideo"></video>')[0]:e('<video preload="auto" crossorigin="anonymous" webkit-playsinline playsinline id="wireWaxVideo"><source src="'+o+'" type="video/mp4" ><source src="'+r+'" type="video/webm" ><source src="'+t+'" type="video/mp4"  ><source src="'+i+'" type="video/webm" onerror="window.wirewax.onVideoError(parentNode)" ></video>')[0],n){var d=e('<img style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 100; cursor: pointer;" class="fallback-poster-image" src="'+n+'"/>');d.bind(a.CLICK_EVENT,function(e){a.PLAY_FUNCTION(),setTimeout(function(){f.setCurrentTime("boo",0)},50)}),e("#tag-overlay").append(d)}return c},createImageSource:function(){var n=e('<img src="'+f.fixedImage360+'"/>');n.attr("crossOrigin","anonymous"),f.source360=n[0]},createVideoInCanvasSource:function(){var e=a.RENDITION;a.IS_DESKTOP&&"4k"===a.BANDWIDTH_PREFERRED_RENDITION&&(e=2160);var n=16*e/9;f.source360=document.createElement("canvas"),f.source360.width=n,f.source360.height=e,f.ie11canvas={width:n,height:e,context:f.source360.getContext("2d")}},setupLoadTimeEvent:function(){var n=(new Date).getTime();e(f.internalVideoElement).bind("canplaythrough",function(){o.publish(a.LOAD_METRIC,{type:8,urls:[f.internalVideoElement.currentSrc],loadTime:(new Date).getTime()-n}),e(f.internalVideoElement).unbind("canplaythrough")})},getAvailableRenditions:function(){return["1080","720","540","360","180"]},switchRendition:function(n,t){var i=f.vidId;o.publish(a.SHOW_LOADER),f.pause(!0);var r=f.getCurrentTime();e(f.internalVideoElement).children("source").remove();var c=document.createElement("source");c.src=f.cdnURL+"vidData/"+i+"/"+i+"_"+t+".webm",e(f.internalVideoElement).append(c);var d=document.createElement("source");d.src=f.cdnURL+"vidData/"+i+"/"+i+"_"+t+".mp4",e(f.internalVideoElement).append(d);var l=function(){var n=function(){window.setTimeout(function(){f.play(!0),a.RENDITION=t,o.publish(a.RENDITION_CHANGED),o.publish(a.HIDE_LOADER),e(f.internalVideoElement).unbind("seeked",n)},1e3)};e(f.internalVideoElement).unbind("loadedmetadata",l),e(f.internalVideoElement).bind("seeked",n),f.internalVideoElement.currentTime=r};e(f.internalVideoElement).unbind("loadedmetadata").bind("loadedmetadata",l),f.internalVideoElement.load()},getCurrentRendition:function(){var e=f.vidId,n=f.internalVideoElement.currentSrc,t=n.indexOf(e.toString()+"_")+e.toString().length,i=n.substring(t).indexOf(".");return n.substring(t+1,t+i)},getVolume:function(){return f.internalVideoElement.volume},setVolume:function(e){e?f.enableAudio("lol",!0):f.disableAudio(),f.internalVideoElement.volume=e,this._super(e)},play:function(n){var t=this._super;f.initRenderer(function(i){if(!i){if(!a.ENABLE_VIDEO_CANVAS_SOURCE){var o=f.renderer.getCanvas(),r=o.getContext("webgl");r.mozImageSmoothingEnabled=!0,r.webkitImageSmoothingEnabled=!0,r.msImageSmoothingEnabled=!0,r.imageSmoothingEnabled=!0}if(f.attachControlEvents(e("#tag-overlay")[0]),f.internalVideoElement.play(),a.IS_MAC&&a.IS_CHROME&&f.timecode)var c=window.setInterval(function(){f.timecode.renderCode(),f.getFrame()>=f.timecode.getFrame()&&(t(n),window.clearInterval(c))},40);else t(n)}})},pause:function(e){f.playing()&&(f.internalVideoElement.pause(),this._super(e))},seeking:function(){return!f.iphonePlayer&&f.internalVideoElement.seeking},VideoData:function(e){this._super(e)},getAvailableSubtitles:function(){return this._super(),f.videoData?f.videoData.subtitles:[]},seekToFrame:function(e){f.setCurrentTime("junk",parseFloat(e/f.videoData.fps)+1e-4)},frameForward:function(n){if(!f.playing()){f.pauseOnSeek=!0;var t=f.getFrame()+1,i=(t-1)/f.videoData.fps+1e-4,o=function(t){if(n){var a=function(){t&&f.getCurrentTime()!==i||(e(f.internalVideoElement).unbind("seeked",a),n(o))};e(f.internalVideoElement).bind("seeked",a)}f.setCurrentTime("junk",i)};o(!1)}},frameBack:function(n){if(!f.playing()){f.pauseOnSeek=!0;var t=f.getFrame()-1,i=(t-1)/f.videoData.fps+1e-4,o=function(a){if(n){var r=function(){a&&f.getCurrentTime()!==i||(e(f.internalVideoElement).unbind("seeked",r),n(o))};e(f.internalVideoElement).bind("seeked",r),f.setCurrentTime("junk",t/f.videoData.fps+1e-4)}f.setCurrentTime("junk",i)};o(!1)}},getFrame:function(){return Math.floor((f.internalVideoElement.currentTime+1e-4)*f.videoData.fps)+1},setFrame:function(e){var n=e-25,t=f.videoData.fps*(n-1)+1e-4;f.setCurrentTime("junk",t)},goToTag:function(e,n){e&&(n||window.setTimeout(function(){a.PLAY_FUNCTION()},100),window.setTimeout(function(){o.publish(a.HIDE_LOADER),o.publish(a.DO_SEEK,e.tagStartTime),n||e.tagClick()},1e3))},getCurrentTime:function(e){return f.internalVideoElement.currentTime},setCurrentTime:function(e,n){if(!isNaN(n))try{this._super(e,n),f.iphonePlayer?(f.iphonePlayer.setTime.call(f.iphonePlayer,n,!0),f.render(),f.seeked()):f.internalVideoElement.currentTime=n}catch(e){console.log("Invalid current time "+n)}},getBuffered:function(){var e=0,n=f.internalVideoElement.buffered;if(n.length>0){for(var t=0,i=0;i<n.length;i++)n.end(i)>t&&(t=parseFloat(n.end(i)));e=t}else 4===f.internalVideoElement.readyState?(e=f.internalVideoElement.duration,isNaN(e)&&(e=0)):e=0;return e},getNetworkState:function(){return f.internalVideoElement.networkState},playing:function(){return!f.internalVideoElement.paused&&f.startedPlaying},paused:function(){return f.internalVideoElement.paused},playPause:function(){f.internalVideoElement.paused?f.play():f.pause()},getReadyState:function(){var e=f.internalVideoElement.readyState;return e<2?0:e>=2&&e<4?2:e>=4?4:void 0},load:function(){f.internalVideoElement.load()},onError:function(){3===f.getNetworkState()?o.publish(a.ERROR,new c(a.ERROR,a.ERRORS[5018])):o.publish(a.ERROR,new c(a.ERROR,a.ERRORS[5024]))},preSeekStallCheck:function(){f.stallCheckTimeout&&window.clearTimeout(f.stallCheckTimeout),f.stallCheckTimeout=window.setTimeout(function(){f.stallCheckTimeout=null,o.publish(a.SHOW_LOADER),o.publish(a.STARTED_BUFFERING)},1e3)},postSeekStallCheck:function(){f.render(),f.stallCheckTimeout?window.clearTimeout(f.stallCheckTimeout):(o.publish(a.ENDED_BUFFERING),o.publish(a.HIDE_LOADER))},initialise:function(){e(f.internalVideoElement).bind("seeked",this.seeked),e(f.internalVideoElement).bind("ended",f.onEnd);var n=o.subscribe(a.HAS_PLAYED,function(){e(window).resize(),o.unsubscribe(n),f.internalVideoElement.removeAttribute("poster"),e("#tag-overlay").find(".fallback-poster-image").remove()});a.ENABLE_STALL_DETECTION&&(o.subscribe(a.DO_SEEK,f.preSeekStallCheck),o.subscribe(a.HAS_SEEKED,f.postSeekStallCheck)),a.IS_IPHONE||a.IS_IPAD||e("#tag-overlay").on("dblclick",function(){a.PREVENT_VIDEO_DOUBLE_CLICK||f.playPause()}),f.mainLoop(),this._super();var t=!a.IS_DESKTOP&&a.CAN_AUTOPLAY,i=a.IS_DESKTOP&&a.IS_CHROME&&a.IS_CHROME_VERSION>=66;(t||i)&&(f.disableAudio(),a.AUDIO_DISABLED=!0)}})});